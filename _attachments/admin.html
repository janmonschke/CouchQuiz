<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="format-detection" content="telephone=no">
    <link rel="shortcut icon" href="favicon.ico" />
    <title>Das Ultimatum Quiz - Admin</title>
    <script src="js/jquery.js"></script>
    <script src="js/jquery.couch.js"></script>
    <!--<script src="js/app.js"></script>-->
    <link rel="stylesheet" type="text/css" href="style/main.css">
  </head>
  <body>
    <div id="controls">
      <div class="creation">
        <label for="questions">Lokal gespeicherte Fragen</label>
        <select id="questions">
            <option value="1" selected>Flüchtlinge</option>
            <option value="2">123</option>
        </select>
        <button id="remove">Löschen</button>
        <button id="store">Speichern</button>
      </div>
      <div class="presentation">
        <button id="send">Frage senden</button>
      </div>
    </div>
    <div id="workarea" class="flexbox">
      <h1 id="question" contenteditable>Wie viele Ost-Deutsche sind 1958 nach Westdeutschland geflüchtet?</h1>
      <ul id="answers">
        <li><div><span contenteditable>2 000</span></div></li>
        <li><div><span contenteditable>20 000</span></div></li>
        <li><div><span contenteditable>200 000</span></div></li>
        <li><div><span contenteditable>2 000 000</span></div></li>
      </ul>
    </div>
    <script type="text/javascript">
      var store = {
        init: function(){
          this.$answers = $('#answers span');
          this.$answerHolders = $('#answers div');
          this.$questions = $('#questions');
          if(localStorage["questions"]){
            questions = JSON.parse(localStorage["questions"]);
          }
          
          this.renderQuestions();
          
          this.$answers.click(function(e){ e.stopPropagation(); });
          this.$answerHolders.click( $.proxy(this, 'pickCorrectAnswer') );
          this.$questions.change( $.proxy(this, 'loadQuestion') );
          $('#store').click( $.proxy(this, 'storeQuestion') );
          $('#remove').click( $.proxy(this, 'removeQuestion') );
        },
        renderQuestions: function(){
          var fragen = $('<select>');
          
          for(question in questions){
            fragen.append($('<option>').attr('value', question).text(questions[question].title));
          }
          
          $('#fragen').replaceWith(fragen);
        },
        pickCorrectAnswer: function(event){
          this.$answerHolders.removeClass('picked');
          $(event.target).addClass('picked');
        },
        storeQuestion: function(){
          var question = this.getQuestion();
          if(!question) return false;
          
          questions[question[0]] = question[1];
          localStorage['questions'] = JSON.stringify(questions);
        },
        removeQuestion: function(){
          delete questions[this.$questions.value];
          localStorage['questions'] = JSON.stringify(questions);
          this.renderQuestions();
        },
        loadQuestion: function(){
          setQuestion(questions[this.$questions.value]);
        },
        getQuestion: function(){
          var answers = [];
          var somethingIsPicked = false;
          var correctAnswer = "";

          for(var i=0, l=this.$answers.length; i<l; i++){
            var answer = this.$answers.eq(i).text();
            if(this.$answers.eq(i).hasClass('picked')){
              somethingIsPicked = true;
              correctAnswer = answer;
            }
            answers.push(answer);
          }
          
          if(!somethingIsPicked) {
            alert('Please click on the right answer!');
            return false;
          }  
          
          var name = prompt('Question Name (camel case)');
          
          return [
            name, {
              title: $('#question').text(),
              answers: answers,
              correctAnswer: correctAnswer
            }
          ];
        },
        setQuestion: function(question){
          $('#question').text(question.title);
          
          this.$answers.removeClass();
          
          for(var i=0; i<4; i++){
            var answer = question.answers[i];
            this.$answers.eq(i).text(answer);
            if(answer === question.correctAnswer) this.$answers.eq(i).addClass('picked');
          }
        },
        sendQuestion: function(){
          var question = this.getQuestion();
          if(!question) return false;
          console.log('sending:', question);
        }
      };
      store.init();
    </script>
  </body>
</html>
